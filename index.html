<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>冬季只見線之旅 ❄️</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background: linear-gradient(180deg, #dbeafe 0%, #eff6ff 100%); color: #475569; overflow-x: hidden; }
        .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.6); }
        .day-btn.active { background-color: #38bdf8; color: white; transform: scale(1.05); }
        #loading-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .snowflake { position: fixed; top: -10px; color: white; z-index: 0; animation: fall linear infinite; pointer-events: none; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
    </style>
</head>
<body class="pb-24">
    <div id="loading-screen">
        <div class="text-sky-400 text-6xl mb-4 animate-spin"><i class="fas fa-snowflake"></i></div>
        <p id="loading-text" class="text-sky-500 font-bold">同步行程資料中...</p>
    </div>

    <div id="snow-container"></div>

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 px-6 py-4 shadow-sm">
        <h1 id="trip-title" class="text-xl font-black text-sky-500 tracking-wider">冬季只見線之旅 ☃️</h1>
    </header>

    <main id="app-content">
        <section id="tab-schedule" class="tab-content">
            <nav id="day-tabs" class="flex overflow-x-auto p-4 gap-3 hide-scroll"></nav>
            <div id="schedule-container" class="px-4 pb-4 space-y-5"></div>
        </section>
        
        <section id="tab-expenses" class="tab-content hidden px-5 py-6">
            <div class="bg-gradient-to-r from-sky-400 to-blue-400 rounded-3xl p-6 shadow-lg text-white text-center mb-6">
                <h2 id="total-expense" class="text-4xl font-black">¥ 0</h2>
            </div>
            <div id="expense-list" class="space-y-3"></div>
        </section>
    </main>

    <footer class="fixed bottom-6 left-6 right-6 h-16 bg-white/90 backdrop-blur-md rounded-full shadow-2xl flex justify-around items-center z-50">
        <button onclick="switchTab('schedule')" class="text-sky-400"><i class="fas fa-map text-xl"></i></button>
        <button onclick="switchTab('expenses')" class="text-slate-300"><i class="fas fa-yen-sign text-xl"></i></button>
    </footer>

    <script>
        const apiUrl = "https://script.google.com/a/macros/mail3.hwsh.tc.edu.tw/s/AKfycbyn4CPX5ob1SuNsJ9a2d-PUXmfabbmGleyNgMZQijPgZrpqilEYReg1LwDDZuDc3BTP/exec";

        async function fetchTravelData() {
            try {
                const res = await fetch(apiUrl + "?t=" + Date.now());
                const travelData = await res.json();
                if (travelData.error) throw new Error(travelData.error);
                document.getElementById('loading-screen').style.display = 'none';
                renderSchedule(travelData);
            } catch (e) {
                document.getElementById('loading-text').innerHTML = "讀取失敗，請確認 GAS 權限設定為「所有人」。";
                console.error(e);
            }
        }

        function renderSchedule(data) {
            const tabs = document.getElementById('day-tabs');
            const container = document.getElementById('schedule-container');
            data.days.forEach((d, i) => {
                const btn = document.createElement('button');
                btn.className = `day-btn px-5 py-2 rounded-full border ${i===0?'active bg-sky-400 text-white':''}`;
                btn.innerText = `Day ${d.day}`;
                btn.onclick = () => showDay(d.day, btn);
                tabs.appendChild(btn);

                const dayDiv = document.createElement('div');
                dayDiv.id = `day-${d.day}`;
                dayDiv.className = `day-sec ${i===0?'':'hidden'}`;
                d.items.forEach(item => {
                    dayDiv.innerHTML += `
                        <div class="glass-card rounded-3xl overflow-hidden shadow-sm p-4">
                            <h3 class="font-bold text-lg">${item.title}</h3>
                            <p class="text-sm text-slate-500">${item.time} - ${item.desc}</p>
                        </div>`;
                });
                container.appendChild(dayDiv);
            });
        }

        function showDay(day, btn) {
            document.querySelectorAll('.day-sec').forEach(s => s.classList.add('hidden'));
            document.getElementById(`day-${day}`).classList.remove('hidden');
            document.querySelectorAll('.day-btn').forEach(b => b.className = 'day-btn px-5 py-2 rounded-full border');
            btn.className = 'day-btn px-5 py-2 rounded-full border active bg-sky-400 text-white';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        }

        window.onload = fetchTravelData;
    </script>
</body>
</html>